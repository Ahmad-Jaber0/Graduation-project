<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Content</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'css/EnterQuiz.css' %}">
</head>
<body>
    <header>
        <a href="{% url 'home' %}" class="logo">LoomingCode</a>
        <nav class="navigation" id="nav-middle">
            <a href="{% url 'home' %}">Home</a>
            <a href="{% url 'home' %}#courses">Courses</a>
            <a href="{% url 'home' %}#services">Services</a>
            <a href="{% url 'home' %}#about">About</a>
            <a href="{% url 'home' %}#contact">Contact</a>
        </nav>
        <nav class="navigation">
            <a href="#" id="profile"><i class="fa-regular fa-user fa-lg"></i></a>
            <a href="{% url 'login' %}"><i class="fa fa-right-to-bracket fa-lg"></i></a>
            <a href="{% url 'logout_page' %}"><i class="fa-solid fa-right-from-bracket fa-lg"></i></a>
        </nav>
    </header>

    <form id="quizForm" method="POST" action="{% url 'save_quiz' %}">
        {% csrf_token %}
        <div class="message" id="message">
            <div class="label-and-feild-container">
                <label for="QuestionNumber"><b>Question number:</b></label>
                <input type="number" id="QuestionNumber" name="question_number" required>
            </div>
            <div class="label-and-feild-container"> 
                <label for="QuestionMark"><b>Question mark:</b></label>
                <input type="number" id="QuestionMark" name="question_mark" required>
            </div>
            <div class="label-and-feild-container"> 
                <label for="QuestionTopics"><b>Question topics:</b></label>
                <select id="QuestionTopics" name="question_topics" required multiple>
                    {% for topic in topics %}
                    <option value="{{ topic.id }}">{{ topic.topic_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="label-and-feild-container"> 
                <label for="QuestionSectionsCount"><b>Question sections count:</b></label>
                <input type="number" id="QuestionSectionsCount" name="question_sections_count" required>
            </div>

            <div>
                <center>
                    <button type="button" id="enterQuestion-button" data-element="enter-question" onclick="func(this)">Enter question</button>
                    <span></span>
                    <button type="button" id="CANCEL-button" onclick="closeMessage()">Cancel</button>
                </center>
            </div>
        </div>

        <div id="editor" class="editor" contenteditable></div>
        
        <div class="savebtn-cancelbtn-container">
            <input type="hidden" id="correctAnswers" name="correct_answers[]">
            <button type="button" class="beautiful-button" id="next-question" onclick="nextQuestion()">Next question</button>
            <button type="submit" class="beautiful-button" id="generate-html">Save and return</button>
        </div>
    </form>

    <script>
        let questionNumber;
        let questionMark;
        let questionTopics = [];
        let questionSectionsCount;

        const editorElement = document.getElementById('editor');
        const quizForm = document.getElementById('quizForm');

        function nextQuestion() {
            const editorContent = editorElement.innerHTML.trim();
            if (editorContent) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'html_content';
                input.value = editorContent;
                quizForm.appendChild(input);

                // Create inputs for each section's options
                for (let i = 0; i < questionSectionsCount; i++) {
                    const options = document.querySelectorAll(`input[name="answer-variable${questionNumber}${i + 1}"]`);
                    options.forEach(option => {
                        const optionInput = document.createElement('input');
                        optionInput.type = 'hidden';
                        optionInput.name = `question_section_${i + 1}_options`;
                        optionInput.value = option.nextElementSibling.innerText.trim();
                        quizForm.appendChild(optionInput);
                    });
                }

                quizForm.submit();
            } else {
                alert('Please enter content.');
            }
        }

        function func(button) {
            const elementType = button.getAttribute('data-element');
            const selection = window.getSelection();
            const range = selection.getRangeAt(0);

            switch (elementType) {
                case 'enter-question':
                    questionNumber = document.getElementById("QuestionNumber").value;
                    questionMark = document.getElementById("QuestionMark").value;
                    questionTopics = Array.from(document.getElementById("QuestionTopics").selectedOptions).map(option => option.value);
                    questionSectionsCount = document.getElementById("QuestionSectionsCount").value;

                    if (!questionNumber || !questionMark || questionTopics.length === 0 || !questionSectionsCount) {
                        alert("Please fill in all fields.");
                        return;
                    }

                    enterQuestion();
                    addQuestionToEditor();
                    break;
            }
        }

        function enterQuestion() {
            document.querySelector('label[for="QuestionNumber"]').style.display = 'none';
            document.getElementById("QuestionNumber").style.display = "none";
            document.querySelector('label[for="QuestionMark"]').style.display = 'none';
            document.getElementById("QuestionMark").style.display = "none";
            document.querySelector('label[for="QuestionTopics"]').style.display = 'none';
            document.getElementById("QuestionTopics").style.display = "none";
            document.querySelector('label[for="QuestionSectionsCount"]').style.display = 'none';
            document.getElementById("QuestionSectionsCount").style.display = "none";
            document.getElementById("enterQuestion-button").style.display = "none";
            document.querySelector('span').style.display = 'none';
            document.getElementById("CANCEL-button").style.display = "none";
        }

        function addQuestionToEditor() {
            let content = `<div class="text">Q${questionNumber}: </div><br><br>`;
            for (let i = 1; i <= questionSectionsCount; i++) {
                const sectionNumber = prompt("Enter question section number");
                content += `${sectionNumber}. <br>`;
                const ansOptionsNum = prompt("Enter number of answer options");
                const name = `answer-variable${questionNumber}${i}`;
                let checkBoxHtml = "";
                for (let j = 1; j <= ansOptionsNum; j++) {
                    const id = `${questionNumber}${i}${j}`;
                    checkBoxHtml += `<div><input type="radio" name="${name}" id="${id}" onclick="setCorrectAnswer(${i}, this.id)"><label contenteditable>&nbsp;&nbsp;&nbsp;<br></div>`;
                }
                checkBoxHtml += '<br>';
                content += checkBoxHtml;
            }
            editorElement.innerHTML = content;
        }

        function setCorrectAnswer(sectionIndex, id) {
            let correctAnswers = document.getElementById('correctAnswers').value.split(',');
            correctAnswers[sectionIndex - 1] = id;
            document.getElementById('correctAnswers').value = correctAnswers.join(',');
        }

        function closeMessage() {
            document.getElementById("message").style.display = "none";
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("message").style.display = "block";
        });
    </script>
</body>
</html>
